<!DOCTYPE html>
<html>

<head>
    <title>DOSArchive</title>
    <script src="js/js-dos.js"></script>
</head>
<style>
    #title {
        color: white;
        flex: 1;
        text-align: center;
        font-family: "Consolas";
        flex-wrap: wrap;
    }

    #jsdos {
        width: 960px;
        height: 600px;
    }
</style>

<body style="background-color: black;">
    <h1 id="title">DOSArchive Interactive</h1>
    <canvas id="jsdos"></canvas>
    <button style="position: absolute; right: 1em; top: 1em;" onclick="ci.fullscreen()">Fullscreen</button>
    <button style="position: absolute; right: 1em; top: 3em;" onclick="resetCache()">Reset Cache</button>
    <button style="position: absolute; right: 1em; top: 5em;" onclick="window.location.reload()">Run Again</button>
    <button style="position: absolute; right: 1em; top: 7em;" onclick="window.history.back()">Go Back</button>
    <script>
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
        }

        function resetCache() {
            window.indexedDB.databases().then(dbs => {
                dbs.forEach(db => { window.indexedDB.deleteDatabase(db.name) });
            });
        }

        Dos(document.getElementById("jsdos"), {
            wdosboxUrl: "js/wdosbox.js",
            cycles: 1000,
            autolock: false,
        }).ready(function (fs, main) {
            fs.extractAll([
                { url: "dist/RUN.zip", mountPoint: "/" },
                { url: "dist/SCREEN.zip", mountPoint: "/ARCHIVE/SCREEN" },
                { url: "dist/SUN.zip", mountPoint: "/ARCHIVE/SUN" },
                { url: "dist/ARABART.zip", mountPoint: "/ARCHIVE/ARABART" },
                { url: "dist/ARABIC.zip", mountPoint: "/ARCHIVE/ARABIC" },
                { url: "dist/EDIT.zip", mountPoint: "/ARCHIVE/EDIT" },
                { url: "dist/FORM_X.zip", mountPoint: "/ARCHIVE/FORM_X" },
                { url: "dist/KVC.zip", mountPoint: "/ARCHIVE/KVC" },
                { url: "dist/NAMES.zip", mountPoint: "/ARCHIVE/NAMES" },
                { url: "dist/PESM.zip", mountPoint: "/ARCHIVE/PESM" },
                { url: "dist/PORTSAID.zip", mountPoint: "/ARCHIVE/PORTSAID" },
                { url: "dist/DIGI_T.zip", mountPoint: "/ARCHIVE/DIGI_T" },
                { url: "dist/TAHER.zip", mountPoint: "/ARCHIVE/TAHER" },
                { url: "dist/WINKEY.zip", mountPoint: "/ARCHIVE/WINKEY" }
            ]).then(function () {
                //Let's build the arguments
                let cmd = [];

                //First we need to run ARABART, regardless if we need it.
                cmd.push('-c', 'cls');
                cmd.push('-c', 'cd c:\\ARCHIVE\\ARABART');
                cmd.push('-c', 'ARABART.EXE > /DEV/NULL');
                cmd.push('-c', 'cls');

                //Now we move into the directory needed to run the program
                cmd.push('-c', 'cd c:\\ARCHIVE\\' + getQueryVariable('program').split('-')[0]);

                //Now, if there is a specific argument (dash), run it, otherwise just run RUN.BAT
                cmd.push('-c', (getQueryVariable('program').split('-').length > 1) ? getQueryVariable('program').split('-')[1] : 'RUN.BAT')
                main(cmd).then(function (ci) {
                    window.ci = ci;
                });
            });
        });
    </script>
</body>

</html>