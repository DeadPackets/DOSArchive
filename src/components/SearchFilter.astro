---
import { getYears, getLanguages, getCategories } from '../data/programs';

const years = getYears();
const languages = getLanguages();
const categories = getCategories();
---

<div class="search-filter" role="search" aria-label="Filter programs">
  <div class="search-input-wrap">
    <span class="search-prompt" aria-hidden="true">FIND&gt;</span>
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search programs..."
      aria-label="Search programs by name or description"
      autocomplete="off"
    />
  </div>

  <div class="filter-row">
    <div class="filter-group" role="group" aria-label="Filter by year">
      <span class="filter-label">Year:</span>
      {years.map(year => (
        <button class="filter-btn filter-btn-year" data-filter-year={year}>{year}</button>
      ))}
    </div>

    <div class="filter-group" role="group" aria-label="Filter by language">
      <span class="filter-label">Lang:</span>
      <select id="language-filter" class="filter-select" aria-label="Filter by language">
        <option value="">All</option>
        {languages.map(lang => (
          <option value={lang}>{lang}</option>
        ))}
      </select>
    </div>

    <div class="filter-group" role="group" aria-label="Filter by category">
      <span class="filter-label">Type:</span>
      <select id="category-filter" class="filter-select" aria-label="Filter by category">
        <option value="">All</option>
        {categories.map(cat => (
          <option value={cat}>{cat}</option>
        ))}
      </select>
    </div>

    <button class="filter-clear" id="filter-clear" style="display:none;">Clear</button>
  </div>
</div>

<style>
  .search-filter {
    margin-bottom: 2rem;
  }

  .search-input-wrap {
    display: flex;
    align-items: center;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    padding: 0 1rem;
    margin-bottom: 1rem;
  }

  .search-prompt {
    font-family: var(--font-display);
    font-size: 1.1rem;
    color: var(--color-phosphor-dim);
    margin-right: 0.5rem;
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--color-text-bright);
    font-family: var(--font-body);
    font-size: 0.85rem;
    padding: 0.7rem 0;
    caret-color: var(--color-phosphor);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.25rem;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .filter-label {
    font-family: var(--font-display);
    font-size: 1rem;
    color: var(--color-text-muted);
    letter-spacing: 0.05em;
  }

  .filter-btn {
    font-family: var(--font-display);
    font-size: 1rem;
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    padding: 0.2rem 0.6rem;
    cursor: pointer;
    transition: all 0.15s ease;
    letter-spacing: 0.03em;
  }

  .filter-btn:hover {
    border-color: var(--color-phosphor-dim);
    color: var(--color-phosphor);
  }

  .filter-btn.active {
    border-color: var(--color-amber-dim);
    color: var(--color-amber);
    background: rgba(255, 176, 0, 0.06);
  }

  .filter-select {
    font-family: var(--font-display);
    font-size: 1rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    outline: none;
    letter-spacing: 0.03em;
  }

  .filter-select:focus {
    border-color: var(--color-phosphor-dim);
  }

  .filter-select option {
    background: var(--color-surface);
    color: var(--color-text);
  }

  .filter-clear {
    font-family: var(--font-display);
    font-size: 0.95rem;
    background: transparent;
    border: 1px solid var(--color-red);
    color: var(--color-red);
    padding: 0.2rem 0.6rem;
    cursor: pointer;
    transition: all 0.15s ease;
    margin-left: auto;
  }

  .filter-clear:hover {
    background: var(--color-red);
    color: var(--color-bg);
  }

  @media (max-width: 640px) {
    .filter-row {
      gap: 0.75rem;
    }
    .filter-clear {
      margin-left: 0;
    }
  }
</style>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const yearButtons = document.querySelectorAll('.filter-btn-year');
  const languageFilter = document.getElementById('language-filter') as HTMLSelectElement;
  const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
  const clearBtn = document.getElementById('filter-clear') as HTMLButtonElement;
  const grid = document.getElementById('program-grid');

  let activeYear: string | null = null;

  function applyFilters() {
    const searchTerm = searchInput?.value.toLowerCase().trim() || '';
    const selectedLang = languageFilter?.value || '';
    const selectedCat = categoryFilter?.value || '';

    const cards = grid?.querySelectorAll('.program-card') as NodeListOf<HTMLElement>;
    let hasVisible = false;

    cards?.forEach(card => {
      const title = card.dataset.title || '';
      const desc = card.dataset.description || '';
      const tags = card.dataset.tags || '';
      const year = card.dataset.year || '';
      const lang = card.dataset.language || '';
      const cat = card.dataset.category || '';

      const matchesSearch = !searchTerm ||
        title.includes(searchTerm) ||
        desc.includes(searchTerm) ||
        tags.includes(searchTerm);
      const matchesYear = !activeYear || year === activeYear;
      const matchesLang = !selectedLang || lang === selectedLang;
      const matchesCat = !selectedCat || cat === selectedCat;

      const visible = matchesSearch && matchesYear && matchesLang && matchesCat;
      card.style.display = visible ? '' : 'none';
      if (visible) hasVisible = true;
    });

    // Show/hide clear button
    const hasFilters = searchTerm || activeYear || selectedLang || selectedCat;
    if (clearBtn) clearBtn.style.display = hasFilters ? '' : 'none';
  }

  searchInput?.addEventListener('input', applyFilters);
  languageFilter?.addEventListener('change', applyFilters);
  categoryFilter?.addEventListener('change', applyFilters);

  yearButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const year = (btn as HTMLElement).dataset.filterYear || '';
      if (activeYear === year) {
        activeYear = null;
        btn.classList.remove('active');
      } else {
        yearButtons.forEach(b => b.classList.remove('active'));
        activeYear = year;
        btn.classList.add('active');
      }
      applyFilters();
    });
  });

  clearBtn?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    activeYear = null;
    yearButtons.forEach(b => b.classList.remove('active'));
    if (languageFilter) languageFilter.value = '';
    if (categoryFilter) categoryFilter.value = '';
    applyFilters();
  });
</script>
